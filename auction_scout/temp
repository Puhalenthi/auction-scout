import json
import os
import time
from typing import Dict, List

from azure.ai.inference import ChatCompletionsClient
from azure.ai.inference.models import SystemMessage, UserMessage
from azure.core.credentials import AzureKeyCredential


class GPTNameChecker:
    def __init__(self, model: str = "openai/gpt-5-mini") -> None:
        token = os.environ.get("GITHUB_TOKEN")
        if not token:
            raise RuntimeError("GITHUB_TOKEN is not set in the environment.")
        self._client = ChatCompletionsClient(
            endpoint="https://models.github.ai/inference",
            credential=AzureKeyCredential(token),
        )
        self._model = model

    def check_name(self, name: str, city: str, state: str, address: str) -> Dict:
        system = (
            "You are a cautious fact-checking assistant. Only mark a HIT if the name "
            "is a somewhat known figure (either in the local community or globally) and"
            "there is credible public "
            "evidence they live in or near the given city/state/metro. Do not guess or infer private info. "
            "Respond ONLY with a compact JSON object."
        )
        user = (
            "Check this name from a storage auction notice.\n"
            f"Name: {name}\n"
            f"Location: {address}, {city}, {state}\n\n"
            "Return JSON with keys: is_public_figure (bool), is_local (bool), "
            "confidence (0-1), famous_person (string or null), reasoning (short)."
        )
        response = self._client.complete(
            messages=[SystemMessage(system), UserMessage(user)],
            model=self._model,
        )
        content = response.choices[0].message.content
        try:
            data = json.loads(content)
        except json.JSONDecodeError:
            data = {
                "is_public_figure": False,
                "is_local": False,
                "confidence": 0.0,
                "famous_person": None,
                "reasoning": "Model returned non-JSON response.",
                "raw": content,
            }
        time.sleep(0.2)
        return data

    def check_names_batch(self, items: List[Dict[str, str]]) -> List[Dict]:
        if not items:
            return []

        system = (
            "You are a cautious fact-checking assistant. Only mark a HIT if the name "
            "is a somewhat known figure (either in the local community or globally) and "
            "there is credible public evidence they live in or near the given city/state/metro. "
            "Do not guess or infer private info. Respond ONLY with a compact JSON array."
        )
        user = (
            "Check these names from storage auction notices.\n"
            "Return a JSON array of objects with keys: index (int), is_public_figure (bool), "
            "is_local (bool), confidence (0-1), famous_person (string or null), reasoning (short).\n\n"
            f"Items JSON: {json.dumps(items, ensure_ascii=False)}"
        )
        response = self._client.complete(
            messages=[SystemMessage(system), UserMessage(user)],
            model=self._model,
        )
        content = response.choices[0].message.content
        try:
            data = json.loads(content)
            if not isinstance(data, list):
                raise ValueError("Non-list response")
        except Exception:
            data = []

        results: List[Dict] = [
            {
                "is_public_figure": False,
                "is_local": False,
                "confidence": 0.0,
                "famous_person": None,
                "reasoning": "Model returned non-JSON response.",
            }
            for _ in items
        ]

        for obj in data:
            try:
                idx = int(obj.get("index"))
            except Exception:
                continue
            if 0 <= idx < len(results):
                results[idx] = obj

        time.sleep(0.2)
        return results
